{% extends "index.html" %}

{% block content %}
<h1>Visual Novel Generator</h1>
<form action="/generate_visual_novel" method="post">
    <div class="form-group">
        <label for="title">Enter a title:</label>
        <input type="text" class="form-control" id="title" name="title" required>
    </div>
    <input type="hidden" id="character_profiles" name="character_profiles" value="{{ default_character_profiles }}">
    <button type="button" class="btn btn-secondary" id="edit-character-profiles">Edit Character Profiles</button>
    <div id="extra_options" hidden="hidden">
        <div class="form-group">
            <label for="num_characters">Number of characters (min: 1, max: 4):</label>
            <input type="number" class="form-control" id="num_characters" name="num_characters" min="1" max="4"
                style="width: 70px;"">
        </div>
        <div class=" form-group">
            <label for="num_dialogs" data-min="6" data-max="12">Number of dialogs (min: 6, max: 12):</label>
            <input type="number" class="form-control" id="num_dialogs" name="num_dialogs" min="6" max="12" step="1"
                style="width: 70px;">
        </div>
    </div>
    <button type="submit" class="btn btn-primary">Generate Visual Novel</button>
    <div id="loading-icon" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>
</form>
<!-- Insufficient Tokens Modal -->
<div class="modal" tabindex="-1" id="insufficient-tokens-modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Insufficient Tokens</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>You do not have enough tokens. Please purchase more tokens to continue.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary">Purchase More Tokens</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Character Profile Modal -->
<div class="modal" tabindex="-1" id="character-profile-modal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Character Profiles</h5>
                <!-- Modification: Remove 'data-bs-dismiss' and add 'id' attribute -->
                <button type="button" class="btn-close" id="close-character-modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="character-profiles">
                <!-- The character profile form elements will be generated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="save-character-profiles">Save Changes</button>
                <!-- Modification: Remove 'data-bs-dismiss' attribute -->
                <button type="button" class="btn btn-secondary" id="discard-character-profiles">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        // Initialize the modal
        var modal = $('#insufficient-tokens-modal');
        // The default character profiles
        const defaultCharacterProfiles = {{ default_character_profiles| safe
    }};
    const currentCharacterProfiles = JSON.parse(JSON.stringify(defaultCharacterProfiles));

    // The character profile input elements template
    const profileInputTemplate = (character, key, value) => `
      <div class="form-group">
          <label for="${character}-${key}">${key.replace('_', ' ')}:</label>
          <input type="text" class="form-control" id="${character}-${key}" name="${character}-${key}" value="${value}">
      </div>
    `;

    // A function to generate the character profile form elements
    const generateProfileInputs = (profiles) => {
        let profileInputs = '';
        for (const character in profiles) {
            profileInputs += `<h5>${character}</h5>`;
            for (const key in profiles[character]) {
                if (key !== 'likes' && key !== 'dislikes') {
                    profileInputs += profileInputTemplate(character, key, profiles[character][key]);
                }
            }
        }
        return profileInputs;
    };

    // Fill the modal with the default character profiles
    $('#character-profiles').html(generateProfileInputs(defaultCharacterProfiles));

    // Open the character profile modal
    $('#edit-character-profiles').on('click', function () {
        $('#character-profiles').html(generateProfileInputs(currentCharacterProfiles));
        $('#character-profile-modal').modal('show');
    });

    // Save changes to the character profiles
    $('#save-character-profiles').on('click', function () {
        for (const character in defaultCharacterProfiles) {
            for (const key in defaultCharacterProfiles[character]) {
                if (key !== 'likes' && key !== 'dislikes') {
                    const newValue = $(`#${character}-${key}`).val();
                    defaultCharacterProfiles[character][key] = newValue;
                    currentCharacterProfiles[character][key] = newValue;
                }
            }
        }

        let characterProfilesJson = JSON.stringify(defaultCharacterProfiles);
        $('#character_profiles').val(characterProfilesJson);

        $('#character-profile-modal').modal('hide');
    });

    // Set the value of the character_profiles hidden input field
    let characterProfilesJson = JSON.stringify(defaultCharacterProfiles);
    $('#character_profiles').val(characterProfilesJson);

    // Close the modal
    $('#character-profile-modal').modal('hide');
});

    // Modification: Add event listener for the close button and discard changes
$('#close-character-modal, #discard-character-profiles').on('click', function () {
        // Set the value of the character_profiles hidden input field with the default character profiles
        $('#character_profiles').val(JSON.stringify(defaultCharacterProfiles));
        $('#character-profile-modal').modal('hide');
    });

    $('form').on('submit', function (event) {
        event.preventDefault();
        $.ajax({
            url: '/generate_visual_novel',
            method: 'POST',
            data: $(this).serialize(),
            beforeSend: function () {
                // Show the loading icon only if there is no modal
                if (!$('#insufficient-tokens-modal').hasClass('show')) {
                    $('#loading-icon').show();
                }
            },
            success: function (response) {
                if (response.hasOwnProperty('error') && response.error === 'insufficient_tokens') {
                    // Show the Insufficient Tokens Modal
                    var modal = new bootstrap.Modal(document.getElementById('insufficient-tokens-modal'));
                    modal.show();
                    // Hide the loading icon
                    $('#loading-icon').hide();
                } else {
                    // Redirect to the dashboard page with the novel ID
                    window.location.href = '/dashboard?novel_id=' + response.novel_id;
                }
            }
        });
    });
  });
</script>

{% endblock %}